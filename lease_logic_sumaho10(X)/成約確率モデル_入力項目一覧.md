# 成約確率モデル（LightGBM / scikit-learn）入力項目一覧

過去審査データ（past_cases.jsonl）を教師に「成約 / 不成約」または「承認 / 否決」を予測するモデルを組む際に使う**入力項目（特徴量）**の一覧です。  
表形式データとしてそのまま LightGBM や scikit-learn に渡せます。

---

## 1. データソース

- **案件1件**: `past_cases.jsonl` の1行（JSON オブジェクト）
- **教師ラベル**: `final_status` が「成約」なら 1、「失注」なら 0。未登録は学習から除外するか別ラベルに。
- または **判定のみ** で使う場合: `result.hantei` が「承認圏内」なら 1、「要審議」なら 0（否決は 0 または別クラス）。

---

## 2. 入力項目一覧（特徴量）

### 2.1 数値（千円単位・そのまま）

| 項目名（推奨） | 取得元 | 説明 |
|----------------|--------|------|
| `nenshu` | `inputs.nenshu` | 売上高（千円） |
| `gross_profit` | `inputs.gross_profit` | 売上高総利益（千円） |
| `op_profit` | `inputs.op_profit` | 営業利益（千円） |
| `ord_profit` | `inputs.ord_profit` | 経常利益（千円） |
| `net_income` | `inputs.net_income` | 当期利益（千円） |
| `total_assets` | `inputs.total_assets` または `inputs.machines + inputs.other_assets + 他` | 総資産（千円） |
| `net_assets` | `inputs.net_assets` | 純資産（千円） |
| `machines` | `inputs.machines` | 機械・設備（千円） |
| `other_assets` | `inputs.other_assets` | その他資産（千円） |
| `bank_credit` | `inputs.bank_credit` | 銀行与信（千円） |
| `lease_credit` | `inputs.lease_credit` | リース与信（千円） |
| `contracts` | `inputs.contracts` | 契約件数 |
| `lease_term` | `inputs.lease_term` | リース期間（月） |
| `acquisition_cost` | `inputs.acquisition_cost` | 取得原価（千円） |

### 2.2 算出指標（result または inputs から計算）

| 項目名（推奨） | 算出方法 | 説明 |
|----------------|----------|------|
| `revenue_百万` | `nenshu * 1000 / 1e6` | 売上高（百万円） |
| `equity_ratio` | `net_assets / total_assets * 100`（total_assets > 0） | 自己資本比率（%） |
| `op_margin` | `op_profit / nenshu * 100`（nenshu > 0） | 営業利益率（%） |
| `score` | `result.score` | 総合スコア（0–100） |
| `score_borrower` | `result.score_borrower` | 借手スコア |
| `asset_score` | 物件スコア（result または inputs.lease_asset_score） | 物件スコア |
| `contract_prob` | `result.contract_prob` | 契約期待度（%） |

### 2.3 カテゴリ（エンコードして使用）

| 項目名（推奨） | 取得元 | 説明 |
|----------------|--------|------|
| `industry_major` | `industry_major` | 業種大分類（ラベル or One-Hot） |
| `industry_sub` | `industry_sub` | 業種中分類（ラベル or One-Hot） |
| `grade` | `inputs.grade` | 格付（1-3 等） |
| `customer_type` | フォーム | 既存先 / 新規先 |
| `main_bank` | フォーム | メイン先 / 非メイン先 |
| `competitor` | フォーム | 競合なし / 競合あり |
| `contract_type` | `inputs.contract_type` | 契約形態 |
| `deal_source` | `inputs.deal_source` | 商談ソース |

### 2.4 定性スコア（inputs.qualitative_scoring 等）

| 項目名（推奨） | 取得元 | 説明 |
|----------------|--------|------|
| `qual_combined` | 定性スコア合計 | 定性スコアリングの合計点 |
| `qual_rank` | ランク（A–E） | ランクを数値化（A=5, B=4, …） |
| `establishment` | 定性「設立・経営年数」のスコア | 0–100 など |

### 2.5 学習モデル出力（既存のスコアリング結果を使う場合）

| 項目名（推奨） | 取得元 | 説明 |
|----------------|--------|------|
| `legacy_prob` | `result.scoring_result.legacy_prob` | 既存（業種別回帰）デフォルト確率 |
| `ai_prob` | `result.scoring_result.ai_prob` | AI（LightGBM）デフォルト確率 |
| `hybrid_prob` | `result.scoring_result.hybrid_prob` | ハイブリッド確率 |
| `decision` | `result.scoring_result.decision` | 学習モデル判定（承認/否決）→ ラベル化可 |

---

## 3. 学習時の推奨

- **欠損**: 数値は 0 または業種別中央値で補完。カテゴリは "不明" などでまとめる。
- **正規化**: 樹木モデル（LightGBM）なら必須ではないが、スコア・比率はそのままでも可。
- **業種**: 中分類が多すぎる場合は大分類のみ、または業種を embedding してから学習。
- **バランス**: 成約/失注の偏りが大きい場合は class_weight やサンプリングで調整。

---

## 4. 最小セット（まず試す用）

次の項目だけでも成約確率モデルは組めます。

- `nenshu`, `total_assets`, `net_assets`
- `equity_ratio`, `op_margin`（上記から算出）
- `score`, `contract_prob`
- `industry_sub`（ラベルエンコード）
- **目的変数**: `final_status` が「成約」なら 1、それ以外 0

---

## 5. past_cases のキー対応（参考）

| 特徴量 | past_cases 内のパス |
|--------|----------------------|
| nenshu | `inputs.nenshu` |
| total_assets | `inputs` 内の machines + other_assets + 等から集計、または result.financials |
| net_assets | `inputs.net_assets` |
| score | `result.score` |
| industry_sub | トップレベル `industry_sub` |
| final_status（ラベル） | トップレベル `final_status`（成約/失注/未登録） |

実装時は `data_cases.load_all_cases()` で読み、1件ずつ上記項目を抽出して DataFrame 化し、LightGBM の `fit()` に渡します。
