# AIへの教え込みルール

判定ルール（ビジネスルール）と同じ「条件」形式で、**AI相談の回答にだけ**反映される「追加指示」を登録できます。  
業種・スコア・定性ランクなどに合わせて、社内方針や言い回しをAIに教え込めます。

---

## 保存場所

- **ファイル**: `data/ai_teach_rules.json`（リポジトリルートの `data/` 下）
- **UI**: 設定タブ → **🤖 AIへの教え込み**

---

## 仕組み

1. **条件**: 判定ルールと同じ（項目・比較・定数 or 項目同士の比較）。使える項目も同じ（売上高・総資産・スコア・業種・定性スコア・定性ランク など）。**業種（中分類）・業種（大分類）**を選んだときは「値」がドロップダウンになり、審査入力と同じ業種一覧から選べます（例: **76 飲食店**、**09 食料品製造業**、**M 宿泊業・飲食サービス業**）。
2. **教え込み文**: 条件にマッチしたときだけ、AI相談のプロンプトに「【貴社・本件に合わせた追加指示】」として挿入されるテキスト。
3. **適用タイミング**: ユーザーがAI相談で質問を送信するとき。その時点の `last_result`（本件スコア・業種・定性など）からコンテキストを組み、マッチしたルールの指示をすべて連結してプロンプトに追加。

---

## 教え込むとどういう反応があるか

- 条件に合う案件で**AI相談**を使うと、プロンプトに **【貴社・本件に合わせた追加指示（必ず守ること）】** というブロックが自動で入ります。
- その中に、マッチした教え込みルールの「指示文」が箇条書きで並び、AIには **「この追加指示の内容を必ず反映すること」** と【ルール】で伝えています。
- その結果、**回答のトーン・触れるポイント・言い回し**が、教え込みの内容に沿って変わります。

### 反応の例

| 教え込みの例 | 教え込みなしのとき | 教え込みありのとき |
|--------------|--------------------|--------------------|
| 「この業種では返済原資と売上トレンドを必ず触れること」 | 一般的な財務アドバイスになりがち | 回答に**返済原資**と**売上トレンド**の説明が必ず含まれる |
| 「承認ライン直下であることを伝え、具体的なスコアアップ策を1つ以上示すこと」 | 「要審議です」で終わりやすい | **承認ライン直下**と明言し、**数値目標や打ち手**を具体的に書く |
| 「定性面の懸念をやわらかく伝えつつ、補強できる点を述べること」 | 定性の悪さをストレートに指摘しがち | **やわらかい表現**と、**書類・ヒアリングで補強できる点**が入る |

- 複数ルールが同時にマッチした場合は、**すべての指示**がまとめて渡されるので、「業種向け＋スコア直下」のように組み合わせた反応にもできます。
- モデルや質問内容によって言い回しは変わりますが、**教え込みで指定した「必ず触れること」「言い方の方針」**は反映されやすくなります。

---

## 例（スコア・定性）

### スコアの例

| 名前 | 条件 | 教え込み文 |
|------|------|------------|
| スコア直下（承認ライン手前） | 総合スコア が 68 以上 **かつ** 71 未満 | 承認ライン（71点）直下であることを伝え、具体的なスコアアップ策（数値目標・確認すべき書類）を1つ以上示すこと。 |
| スコア高め（承認圏内） | 総合スコア が 75 以上 | スコアは十分圏内であることを簡潔に伝え、定性面や導入効果の確認を促す言い回しにすること。 |
| スコア低め（要フォロー） | 総合スコア が 60 未満 | スコアが基準を下回っていることをやわらかく伝え、改善の優先順位（売上・利益率・自己資本のどれから手を付けるか）を1つ示すこと。 |

### 定性の例

| 名前 | 条件 | 教え込み文 |
|------|------|------------|
| 定性ランク D・E | 定性ランク が D または E（いずれかに含む、値: D, E） | 定性面の懸念をやわらかく伝えつつ、提出書類やヒアリングで補強できる点を具体的に述べること。否定的な表現を避け、次のアクションを明確にすること。 |
| 定性スコア低め | 定性スコア（0–100） が 40 未満 | 定性スコアが低いことを指摘する際は、設立年数・返済履歴・事業将来性など「どの項目を補強するとよいか」を1つ以上挙げること。 |
| 定性ランク A・B（優良） | 定性ランク が A または B（いずれかに含む、値: A, B） | 定性面は問題なしと簡潔に褒め、財務指標や金利交渉など数値面のアドバイスを中心にすること。 |
| スコアは高いが定性が弱い | 総合スコア が 70 以上 **かつ** 定性ランク が D または E | スコアは承認圏内だが定性で引っかかっている旨を伝え、定性項目（返済履歴・事業将来性など）の補強で承認に近づくことを具体的に述べること。 |

### 業種＋スコア・定性の例

| 名前 | 条件 | 教え込み文 |
|------|------|------------|
| 飲食業向け | 業種（中分類） が 「76 飲食店」 に等しい | この業種では返済原資と売上トレンドを必ず触れること。競合店動向があれば言及すること。 |
| 飲食業・スコア直下 | 業種（中分類） が 「76 飲食店」 **かつ** 総合スコア が 71 未満 | 飲食業は手元流動性に触れつつ、スコアアップのためには売上原価率・人件費率の数値目標を1つ示すこと。 |

---

## サンプルJSON（スコア・定性）

`data/ai_teach_rules.example.json` を参照するか、設定タブ「AIへの教え込み」で以下と同様のルールを追加できます。

```json
{
  "version": 1,
  "enabled": true,
  "rules": [
    {
      "id": "ai_teach_score_border",
      "name": "スコア直下（承認ライン手前）",
      "enabled": true,
      "instruction": "承認ライン（71点）直下であることを伝え、具体的なスコアアップ策（数値目標・確認すべき書類）を1つ以上示すこと。",
      "conditions": {
        "and": [
          { "field": "score", "op": "ge", "value": 68 },
          { "field": "score", "op": "lt", "value": 71 }
        ]
      }
    },
    {
      "id": "ai_teach_qual_de",
      "name": "定性ランク D・E",
      "enabled": true,
      "instruction": "定性面の懸念をやわらかく伝えつつ、提出書類やヒアリングで補強できる点を具体的に述べること。否定的な表現を避け、次のアクションを明確にすること。",
      "conditions": { "field": "qual_rank", "op": "in", "value": ["D", "E"] }
    },
    {
      "id": "ai_teach_qual_low",
      "name": "定性スコア低め",
      "enabled": true,
      "instruction": "定性スコアが低いことを指摘する際は、設立年数・返済履歴・事業将来性など「どの項目を補強するとよいか」を1つ以上挙げること。",
      "conditions": { "field": "qual_weighted_score", "op": "lt", "value": 40 }
    },
    {
      "id": "ai_teach_score_high_qual_weak",
      "name": "スコアは高いが定性が弱い",
      "enabled": true,
      "instruction": "スコアは承認圏内だが定性で引っかかっている旨を伝え、定性項目（返済履歴・事業将来性など）の補強で承認に近づくことを具体的に述べること。",
      "conditions": {
        "and": [
          { "field": "score", "op": "ge", "value": 70 },
          { "field": "qual_rank", "op": "in", "value": ["D", "E"] }
        ]
      }
    }
  ]
}
```

条件の書き方（`and` / `or` / `value_field`）は「ルールJSONスキーマと例.md」の判定ルールと同一です。
