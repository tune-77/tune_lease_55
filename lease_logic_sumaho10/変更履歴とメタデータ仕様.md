# 係数/重みの変更履歴と案件メタデータ仕様

審査システムの監査・再現性のため、**係数/重みの変更履歴**と**案件に紐づけるメタデータ**の仕様を整理する。

---

## 1. 係数/重みの変更履歴の保存仕様

### 1.1 目的

- **いつ・何が・どう変わったか**を追えるようにする
- 監査・問い合わせ時に「当時はこの係数/重みだった」と説明できるようにする
- 必要に応じてロールバックや差分確認ができるようにする

### 1.2 保存先

| 種別 | ファイル | 形式 | 備考 |
|------|----------|------|------|
| 係数変更履歴 | `data/coeff_change_log.jsonl` | 1行1JSON（追記のみ） | リポジトリルートの `data/`（`coeff_overrides.json` と同階層） |
| 重み変更履歴 | 上記と同じファイルに統合可、または `data/weight_change_log.jsonl` | 同上 | 運用が簡単なのは **1ファイルに統合**（`type` で区別） |

**推奨**: `data/coeff_change_log.jsonl` に係数・重みの両方を `type` で区別して追記する。

### 1.3 1レコードの項目定義

#### 係数変更（`type: "coeff"`）

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| `timestamp` | string (ISO 8601) | ○ | 変更日時 |
| `type` | string | ○ | `"coeff"` |
| `key` | string | ○ | 更新対象のモデルキー（例: `"全体_既存先"`, `"医療_既存先"`） |
| `after` | object | ○ | 保存後の係数セット（そのキー分のみで可） |
| `before` | object | - | 変更前の係数（任意。差分確認用） |
| `source` | string | ○ | 変更契機（後述） |
| `comment` | string | - | 任意メモ |
| `n_cases` | number | - | 回帰に使った件数（回帰由来の場合） |

#### 重み変更（`type: "score_weights"`）

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| `timestamp` | string (ISO 8601) | ○ | 変更日時 |
| `type` | string | ○ | `"score_weights"` |
| `after` | object | ○ | 保存後の `score_weights`（`borrower`, `asset`, `quant`, `qual`） |
| `before` | object | - | 変更前の重み（任意） |
| `source` | string | ○ | 変更契機（後述） |
| `comment` | string | - | 任意メモ |
| `n_cases` | number | - | 回帰に使った件数（回帰由来の場合） |

#### `source` の取りうる値

| 値 | 意味 |
|----|------|
| `ui_regression` | 係数分析・更新タブで「回帰分析を実行して係数を算出」→「係数を更新して保存」 |
| `ui_regression_bayesian` | 同上タブの「業種・指標ごとにベイズ回帰を実行して保存」 |
| `ui_weight_optimize` | 定量要因分析タブの「回帰で重みを最適化」→「推奨を保存してスコア計算に反映」 |
| `manual` | 手動編集や将来の管理画面など |

### 1.4 記録のタイミング

1. **係数**: `save_coeff_overrides(overrides)` を呼ぶ直前に、変更前の `load_coeff_overrides()` を取得し、保存成功後に `coeff_change_log.jsonl` に追記する。  
   - 対象は「今回更新したキー」だけでも可（`overrides["全体_既存先"]` を更新したなら、そのキーと `after` を1レコードに）。
2. **重み**: 上記と同様に、`score_weights` を更新して `save_coeff_overrides()` した直後に、`type: "score_weights"` の1レコードを追記する。

### 1.5 ログファイルの例

```jsonl
{"timestamp":"2026-02-17T12:00:00","type":"coeff","key":"全体_既存先","after":{"sales_log":0.42,"intercept":-2.1},"source":"ui_regression","n_cases":80}
{"timestamp":"2026-02-17T12:05:00","type":"score_weights","after":{"borrower":0.82,"asset":0.18,"quant":0.62,"qual":0.38},"before":{"borrower":0.85,"asset":0.15,"quant":0.6,"qual":0.4},"source":"ui_weight_optimize","n_cases":65}
```

### 1.6 実装時の注意

- **追記のみ**とし、既存ログの上書き・削除は行わない
- ログが肥大化した場合は、別仕様で「アーカイブ」「サマリ集計」を検討
- `before` は任意のため、初回保存時は省略してよい

---

## 2. 案件に紐づけるメタデータの項目案

### 2.1 目的

- **判定時点の設定を固定**し、同じ入力で「当時どういう設定でスコアが出たか」を再現・説明できるようにする
- 分析・監査で「その案件はどの係数/重みで計算されたか」を参照できるようにする

### 2.2 現状の案件レコード（参考）

判定開始時に `save_case_log(log_payload)` で保存しているペイロードの主な構成:

- `id`, `timestamp`, `final_status`（未登録→成約/失注で更新）
- `inputs`: 業種・取引・財務・定性スコアリング等
- `result`: スコア・判定・契約期待度・定性ランク・学習モデル結果等
- `pricing`: base_rate, pred_rate 等

**不足しているもの**: そのスコアを算出した「係数セット」「重み」「承認ライン」の明示。

### 2.3 追加するメタデータ項目案

判定開始時に `log_payload` に以下のいずれか（または全部）を追加する。

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| `meta_version` | number | - | メタデータ仕様のバージョン（例: `1`）。将来の拡張用。 |
| `score_weights` | object | ○推奨 | 判定時点の重み。`{ "borrower": 0.85, "asset": 0.15, "quant": 0.6, "qual": 0.4 }`。`get_score_weights()` の戻り値をそのまま保存。 |
| `approval_line` | number | - | 判定時点の承認ライン（例: `71`）。定数 `APPROVAL_LINE` を保存。 |
| `coeff_snapshot_key` | string | - | 使用した係数セットのキー（例: `"全体_既存先"`）。どのモデル係数で計算したかの識別用。 |
| `coeff_version` | string | - | 係数の「バージョン」識別子。実装例: `coeff_overrides.json` の該当キー部分のハッシュ、または `coeff_change_log` の直近の `timestamp`。省略可。 |
| `scoring_model_used` | boolean | - | 学習モデル（業種別ハイブリッド）を使用したか。`result.scoring_result != null` と等価だが、明示しておくと分析しやすい。 |
| `score_penalty_applied` | boolean | - | 学習モデル否決によりスコアに 0.5 倍を適用したか。 |

### 2.4 保存タイミングと格納場所

- **タイミング**: 判定開始処理のうち、`last_result` を組み立てたあと・`log_payload` を組み立てる箇所で、上記メタを付与する。
- **格納場所**: `log_payload` のトップレベルに `meta` オブジェクトを1つ用意し、その中に上記を入れる。

例:

```json
{
  "id": "20260217120000000000",
  "timestamp": "2026-02-17T12:00:00",
  "final_status": "未登録",
  "meta": {
    "meta_version": 1,
    "score_weights": { "borrower": 0.85, "asset": 0.15, "quant": 0.6, "qual": 0.4 },
    "approval_line": 71,
    "coeff_snapshot_key": "全体_既存先",
    "scoring_model_used": true,
    "score_penalty_applied": false
  },
  "inputs": { ... },
  "result": { ... },
  "pricing": { ... }
}
```

### 2.5 利用イメージ

- **履歴分析・成約レポート**: 「この案件は借手78%/物件22%の重みで計算された」と表示できる
- **監査**: 「当時の承認ラインは71で、係数は○月○日更新分」と説明できる
- **再計算**: 同じ入力＋同じ `meta.score_weights` / 係数を使えば、スコアを再現できる（再計算機能を別途実装する場合はこのメタを参照）

### 2.6 後方互換

- 既存案件には `meta` が無いため、参照時は `case.get("meta") or {}` とし、`score_weights` 等は無ければ「当時はデフォルトとみなす」でよい
- `meta_version` を付けておくと、将来項目を増やしたときの解釈に使える

---

## 3. 実装の優先度（目安）

| 項目 | 優先度 | 理由 |
|------|--------|------|
| 重み変更時の履歴1行追記（`type: "score_weights"`） | 高 | 実装が軽く、監査でよく聞かれる「重みをいつ変えたか」に対応できる |
| 係数保存時の履歴1行追記（`type: "coeff"`） | 高 | 係数更新のトレーサビリティに直結 |
| 案件への `meta.score_weights` と `meta.approval_line` の付与 | 高 | 判定再現性の要 |
| `meta.coeff_snapshot_key` / `coeff_version` | 中 | 係数バージョンまで厳密に追う場合に有効 |
| `meta.scoring_model_used` / `score_penalty_applied` | 低 | 分析用。無くても `result` から推測可能 |
| 履歴の閲覧UI・ロールバック | 低 | 必要になったら別タスクで |

---

## 4. まとめ

- **変更履歴**: `data/coeff_change_log.jsonl` に係数・重みの変更を追記する。`timestamp`, `type`, `after`, `source` を必ず入れ、`before` は任意。
- **案件メタ**: 判定時に `meta` を追加し、少なくとも `score_weights` と `approval_line` を保存する。必要に応じて係数キー・学習モデル使用有無を追加する。
- 実装時は「係数/重みを保存する処理」の直後に履歴を1行書き、`log_payload` 組み立て時に `get_score_weights()` と `APPROVAL_LINE` を読んで `meta` に載せるだけで、監査と再現性が大きく改善する。
