# lease_logic_sumaho10.py 分割方針

現状 **約7,100行・120超の関数** が1ファイルにあり、編集・テスト・レビューが重い。**分割した方がよい**。リスクを抑えつつ、段階的にモジュール化する。

---

## 1. 結論

| 項目 | 推奨 |
|------|------|
| 分割するか | **する**（メインは「定数・UI・モード分岐」に寄せる） |
| 一気にやるか | **段階的に**（1モジュールずつ切り出して動作確認） |
| 起動方法 | 変わらない（`streamlit run lease_logic_sumaho10/lease_logic_sumaho10.py`） |

---

## 2. 分割の優先順位（リスク低→高）

### Phase 1: 依存が少ない「純粋なロジック」から

| 新モジュール | 移す関数の例 | 行数目安 | 依存 |
|--------------|--------------|----------|------|
| **charts.py** | `plot_gauge`, `plot_gauge_plotly`, `plot_waterfall*`, `plot_benchmark_comparison`, `plot_indicators_*`, `plot_radar_chart*`, `plot_positioning_scatter`, `plot_3d_analysis`, `plot_score_models_comparison_plotly`, `plot_contract_prob_factors_plotly`, `plot_scoring_top5_factors_plotly`, `plot_past_scores_histogram_plotly`, `plot_balance_sheet_plotly`, `plot_break_even_point*` | 約800〜1000行 | `matplotlib`, `plotly`, `numpy`。CHART_STYLE 等の定数は渡すか同ファイルに少量コピー |
| **analysis_regression.py** | `build_design_matrix_*`, `_build_one_row_*`, `_log_to_data_scoring`, `run_regression_*`, `_bootstrap_to_min_size`, `_run_single_quant_analysis`, `run_qualitative_contract_analysis`, `run_quantitative_*`, `_optimize_ensemble_ratio`, `optimize_score_weights_from_regression`, `run_contract_driver_analysis` | 約700行 | `load_all_cases`, `get_effective_coeffs`, `COEFF_*`。データ読みは引数で渡すか、同じパッケージの data 経由 |
| **data_cases.py** | `load_all_cases`, `save_all_cases`, `save_case_log`, `load_coeff_overrides`, `save_coeff_overrides`, `get_score_weights`, `get_effective_coeffs`, `load_consultation_memory`, `append_consultation_memory`, `load_case_news`, `append_case_news`, `find_similar_past_cases` | 約400行 | ファイルパス定数（`CASES_FILE`, `COEFF_OVERRIDES_FILE` 等）。`st.error` は呼び元に戻すか最小限に |

### Phase 2: 外部・AI まわり

| 新モジュール | 移す関数の例 | 行数目安 |
|--------------|--------------|----------|
| **web_services.py** | `fetch_industry_trend_extended`, `fetch_industry_assets_from_web`, `fetch_sales_band_benchmarks`, `fetch_industry_benchmarks_from_web`, `search_bankruptcy_trends`, `search_subsidies_by_industry`, `search_equipment_by_keyword`, `scrape_article_text`, `_load_web_benchmarks_cache`, `_save_web_benchmark`, `get_market_rate` 等 | 約400行 |
| **ai_chat.py** | `_ollama_chat_http`, `_gemini_chat`, `_chat_for_thread`, `chat_with_retry`, `get_ai_byoki_with_industry`, `get_ai_honne_complaint`, `generate_battle_special_move`, `is_ai_available`, `is_ollama_available`, `run_ollama_connection_test` | 約400行 |

### Phase 3: 指標・レポート・PDF

| 新モジュール | 移す関数の例 |
|--------------|--------------|
| **indicators.py** | `compute_financial_indicators`, `analyze_indicators_vs_bench`, `get_indicator_analysis_for_advice`, `get_all_industry_sub_for_benchmarks`, `get_stats` |
| **report_pdf.py** | `build_contract_report_pdf`（既に長いブロックならそのまま1ファイルに） |

---

## 3. メインに残すもの（lease_logic_sumaho10.py）

- **定数**: `APPROVAL_LINE`, `REQUIRED_FIELDS`, `COEFF_OVERRIDES_FILE`, `DEFAULT_WEIGHT_*`, 画面用の定数など
- **Streamlit のエントリ**: サイドバー、`mode` の分岐、各モードの `st.*` による画面組み立て
- **フォーム・入力まわり**: `_slider_and_number`, `red_label`, 業界選択・定性スコアリングの UI ブロック
- **判定フロー**: スコア計算の**呼び出し**（実計算は `get_effective_coeffs` / `get_score_weights` 等、可能なら analysis や data に委譲）
- **各モードの「見た目」**: 係数分析・成約レポート・定性/定量要因分析・結果登録・審査・分析タブのレイアウト

移行後は **メインが 3,000〜4,000 行程度**になることを目安にする。

---

## 4. 実装時のルール（共通）

1. **1モジュールずつ**: 1回の PR で「charts だけ」「data_cases だけ」と分ける。動かしてから次へ。
2. **import はメインから**: `from .charts import plot_gauge_plotly, ...` のようにメインが子を参照。子同士の依存はなるべく減らす（data_cases → analysis_regression は可）。
3. **定数・パス**: メインまたは `config.py` に集約し、必要なものだけ引数で渡す。モジュール内で `st` に依存しない関数は、`st` を渡さずにテストしやすくする。
4. **既存の config / data_holder / scoring**: 役割がかぶらないようにする。`config.py` にパスや定数を足すのは可。

---

## 5. フォルダ構成（案）

```
lease_logic_sumaho10/
  lease_logic_sumaho10.py   # エントリ・定数・UI・モード分岐（短くする）
  config.py                 # 既存
  data_holder.py            # 既存
  charts.py                 # Phase 1: グラフ系
  analysis_regression.py    # Phase 1: 回帰・要因分析
  data_cases.py             # Phase 1: 案件・係数・重みの読み書き
  web_services.py            # Phase 2: 業界取得・検索
  ai_chat.py                # Phase 2: Ollama/Gemini・AI用文言
  indicators.py             # Phase 3: 指標計算・アドバイス用
  report_pdf.py             # Phase 3: 成約レポートPDF
  scoring/                  # 既存
  ...
```

---

## 6. まとめ

- **分割する**: 7,100 行は長いので、**分割して修正しやすくする**のがよい。
- **まず Phase 1**: グラフ（charts）、回帰・要因分析（analysis_regression）、案件・係数まわり（data_cases）から切り出し、メインを 3,000〜4,000 行程度に落とす。
- **段階的に**: 1モジュールずつ切り出して動作確認し、問題なければ次に進む。

必要なら、Phase 2 の「data_cases / analysis_regression 切り出し」から具体的な差分案も書ける。

---

## 7. 実施済み（Phase 1: charts）

- **charts.py** を新規作成し、`CHART_STYLE`・`LOWER_IS_BETTER_NAMES`・`_equity_ratio_display` および全 `plot_*` 関数（plot_gauge 〜 plot_break_even_point_plotly）を移した。
- メイン（lease_logic_sumaho10.py）から上記ブロックを削除し、`from charts import ...` で参照するように変更。
- メインは **約6,300行** に短縮（約7,100行 → 約800行減）。
