# リース審査システム（lease_logic_sumaho10）審査観点での全体評価と改善点

## 1. 全体の評価

### 1.1 強み・良い点

| 観点 | 内容 |
|------|------|
| **多段階スコアリング** | 全体モデル・業種別モデル・指標ベンチの3軸でスコアを出し、借手×重み＋物件×重みで総合化（デフォルト85%/15%。回帰で最適化・保存可）。単一モデルに依存しない設計。 |
| **係数の更新可能性** | 成約/失注の結果登録データでロジスティック回帰を行い、係数を更新できる（係数分析・更新β）。審査実績がモデルに反映される仕組みがある。 |
| **定性の取り込み** | 定性スコアリング（6項目・5段階）と「総合×重み＋定性×重み」（デフォルト60%/40%、回帰で変更可）によるランク（A〜E）で、数値だけでは見えない部分を評価に含めている。 |
| **学習モデルとの融合** | 業種別ハイブリッド（デフォルト確率）を参照でき、本システムの「成約率」と学習モデルの「デフォルト確率」の両方で判断できる。否決時はスコア50%減でリスクを反映。 |
| **説明性** | 契約期待度への寄与要因（メイン取引先・競合・業界動向・自己資本比率等）を一覧表示。学習モデル側のTop5要因も表示され、判定理由を説明しやすい。 |
| **データの蓄積** | 判定結果・定性スコアリング・結果登録（成約/失注）を `past_cases.jsonl` に残し、類似案件検索・成約の正体レポート・回帰分析に利用できる。 |
| **業界・取引コンテキスト** | 業界選択（JSIC）、取引状況（メイン/サブ、競合あり/なし）、ネット検索による業界トレンド・目安を組み合わせて判断材料を増やしている。 |

### 1.2 審査業務としての位置づけ

- **入力1回で**、本社スコア・契約期待度・学習モデル判定・定性ランク・類似案件・グラフまで一通り参照できる。
- **結果登録**で成約/失注を付与すると、そのデータが係数更新・成約分析に使われるため、運用を続けるほどモデルと分析が育つ設計になっている。

---

## 2. 改善点（検討すべき項目）

### 2.1 入力・バリデーション

| 改善点 | 現状 | 提案 |
|--------|------|------|
| **必須項目の明示** | 売上高0や総資産未入力でも判定は実行される。学習モデルは総資産・純資産必須。 | 必須項目（例：売上高・営業利益・総資産・純資産）を明示し、未入力時は警告または判定不可にするオプションを検討する。 |
| **ゼロ除算・異常値** | 売上高0のとき比率は0で計算されているが、`raw_nenshu = max(..., 1.0)` 等で防御している箇所と、していない箇所が混在する可能性。 | 比率計算を集約するヘルパーを用意し、「売上高>0 でないときは比率はNone/0」と仕様を統一する。 |
| **数値範囲の一貫性** | スライダーと直接入力の範囲は修正済みだが、他項目（例：取得価格・与信）の上下限が業務実態と合っているかは要確認。 | 項目ごとの「業務上あり得る範囲」を一覧化し、スライダー/バリデーションと照合する。 |

### 2.2 スコア・判定ロジックの透明性

| 改善点 | 現状 | 提案 |
|--------|------|------|
| **承認ラインの根拠** | 総合スコア71以上で「承認圏内」としているが、71の根拠（社内規定・過去実績）がコード外にある。 | README や設定ファイルに「承認ライン71の根拠」を1行で記載し、変更時は履歴を残す。 |
| **定性スコア未入力時** | 定性を1件も選ばない場合、ランク（A〜E）は出さず「総合スコアのみ」になる。 | 「定性未入力のときは総合スコアのみで判定」と画面の説明文で明記する。 |
| **学習モデル否決時の50%減** | 否決時に全スコアを0.5倍しているが、その係数（0.5）が固定。 | 定数化（例：`SCORE_PENALTY_IF_LEARNING_REJECT = 0.5`）し、必要なら設定で変更できるようにする。 |

### 2.3 結果登録・分析のつながり

| 改善点 | 現状 | 提案 |
|--------|------|------|
| **定性スコアの分析利用** | 定性スコアリングは `result` と `inputs.qualitative_scoring` に保存済み。成約の正体レポート等ではまだ平均財務・定性タグ中心。 | 成約案件の「定性スコア（加重）・合計・ランク」の分布や平均をレポートに追加し、成約に効く定性要因を可視化する。 |
| **回帰の説明変数** | 回帰では COEFF_MAIN_KEYS + COEFF_EXTRA_KEYS を使用。定性スコア（combined_score や項目別）は説明変数に含めていない。 | オプションで「定性スコア（合計または項目ダミー）」を説明変数に加え、成約/失注への寄与を推定できるようにする。 |
| **結果登録の必須項目** | 成約時は獲得レート、失注時は失注理由を入力できるが必須ではない。 | 成約時は獲得レート、失注時は失注理由を必須（または推奨）にし、分析品質を上げる。 |

### 2.4 運用・監査

| 改善点 | 現状 | 提案 |
|--------|------|------|
| **係数変更の履歴** | 係数は overrides で上書き保存されるが、「いつ・誰が・何を」変更したかのログはない。 | 係数更新時にタイムスタンプとコメントを付与して別ファイルに追記する、など簡易な変更履歴を残す。 |
| **判定ログの改ざん防止** | past_cases.jsonl は追記・上書きで更新される。誤削除や上書きのリスクがある。 | バックアップの自動取得（日次コピー等）や、結果登録時の「更新前スナップショット」を別ファイルに1行だけ残す運用を検討する。 |
| **バージョン・再現性** | 係数定義・モデルバージョンがコードとファイルに分散している。 | 判定結果に「係数バージョン」「学習モデル有無」などを1行メタで持たせ、後から同じ条件で再計算できるようにする。 |

### 2.5 UX・パフォーマンス

| 改善点 | 現状 | 提案 |
|--------|------|------|
| **フォームとリアルタイム** | 採用値は入力確定または判定開始で反映。フォームのため、スライダーを動かしただけでは再計算されない。 | 「入力確定」の説明を目立たせる。または、負荷が許容できる範囲で、スライダー変更時に session_state だけ更新してキャプションを更新する等の軽いリアルタイム化を検討する。 |
| **大量案件時の表示** | 過去案件一覧や類似案件は件数が増えると重くなる可能性。 | 一覧は直近N件に制限する、またはページング／仮想スクロールを検討する。 |
| **エラー時のメッセージ** | 例外は `st.error` や `except Exception` で握りつぶしている箇所があり、原因特定が難しい場合がある。 | ログファイルに traceback を書き、画面には「エラーが発生しました。ログを確認してください」と案内する。 |

### 2.6 テスト・保守性

| 改善点 | 現状 | 提案 |
|--------|------|------|
| **単体テスト** | スコア計算・係数マージ・設計行列構築などのロジックにテストがなく、リファクタ時に挙動変更に気づきにくい。 | 主要関数（`calculate_score_from_coeffs`, `get_effective_coeffs`, `build_design_matrix_from_logs` 等）に対する pytest を追加する。 |
| **定数・マジックナンバー** | 71（承認ライン）は `APPROVAL_LINE`、借手/物件・総合/定性の重みは `DEFAULT_WEIGHT_*` と `get_score_weights()` で集約済み。回帰で最適化した重みを `coeff_overrides.json` に保存可能。 | 変更時は REVIEW_EVALUATION とコード内コメントに履歴を残す。 |

---

## 3. 優先度の目安

| 優先度 | 項目 | 理由 |
|--------|------|------|
| 高 | 必須項目の明示と未入力時の扱い | 入力ミスや前提不足のまま判定するリスクを減らす。 |
| 高 | 定性スコアの分析での利用（成約レポート・回帰） | 結果登録で貯めた定性を分析に活かし、施策の効果を測りやすくする。 |
| 中 | 係数・判定ロジックの定数化と説明の明文化 | 監査・社内説明・仕様変更時の手間を減らす。 |
| 中 | 係数変更・判定ログの簡易履歴 | トレーサビリティと障害時の復旧に役立つ。 |
| 低 | 軽いリアルタイム表示・一覧の件数制限 | 使い勝手の向上。 |
| 低 | 単体テストの追加 | 長期保守とリファクタの安全性向上。 |

---

## 4. まとめ

- **全体として**、業種・取引・定性・学習モデルを組み合わせた多層的な審査と、成約/失注の蓄積による係数更新・分析のループがよく設計されている。
- **審査する上で**は、入力の前提をはっきりさせる（必須項目・範囲）、判定根拠とランクの意味を画面で説明する、結果登録データを定性含めて分析に使う、の3点を押さえると、運用と監査の両面で安心しやすい。
- 上記の改善点は、段階的に取り入れられるよう「優先度」を付けてある。まずは必須項目の明示と定性の分析利用から着手するのがおすすめである。
